<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Next Bus ‚Ä¢ Painel</title>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#081423;
      --bg1:#0a2232;

      --panel:#ffffff;

      --text:#0f172a;
      --dim:#475569;

      --stroke:#d8e1ee;
      --stroke2:#e6edf7;

      --shadow: 0 18px 60px rgba(2,10,23,.18);

      --ok:#1fa765;
      --okSoft: rgba(31, 167, 101, .12);

      --r: 18px;
      --pad: clamp(14px, 2.0vw, 22px);

      /* Pagina√ß√£o */
      --bar: #1c5aa6;
      --bar2: #34c6d0;

      /* Cabe√ßalho sutil */
      --header: linear-gradient(180deg, #2f6f9d 0%, #184c75 55%, #0f3b5e 100%);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      overflow:hidden;

      background:
        radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22) 0%, rgba(10,46,62,0) 60%),
        radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14) 0%, rgba(6,18,24,0) 65%),
        radial-gradient(1400px 1100px at 50% 55%, var(--bg1) 0%, var(--bg0) 62%, #040a0f 100%);

      padding: clamp(12px, 2vw, 22px);
      display:grid;
      place-items:center;
    }

    .panel{
      width: min(1500px, 96vw);
      height: calc(100vh - clamp(24px, 4vw, 44px));
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;

      opacity:0;
      transform: translateY(12px);
      animation: inPanel 900ms cubic-bezier(.22,1,.36,1) forwards;
      position:relative;
    }
    @keyframes inPanel{ to{ opacity:1; transform: translateY(0);} }

    /* Cabe√ßalho sutil (estilo clima) */
    .header{
      padding: 14px var(--pad);
      background: var(--header);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.18);
    }
    .h-left{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
    }
    .busIcon{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.16);
      flex: 0 0 auto;
    }
    .busIcon .material-icons-outlined{ font-size: 24px; opacity: .95; }

    .titleBlock{ min-width:0; }
    .title{
      font-size: clamp(18px, 2.2vw, 30px);
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70vw;
    }
    .h-right{
      text-align:right;
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
    }
    .clock{
      font-size: clamp(34px, 4.1vw, 56px);
      font-weight: 900;
      letter-spacing: .06em;
      line-height: 1;
    }
    .lastUpdate{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .92;
    }

    /* Faixa topo do conte√∫do */
    .panelTop{
      padding: 12px var(--pad);
      background: #f3f7ff;
      border-bottom: 1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .panelInfo{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #1f2a44;
    }

    .pager{
      display:flex;
      align-items:center;
      gap: 12px;
      color: #334155;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .bar{
      width: 240px;
      height: 10px;
      border-radius: 999px;
      background: #e7eefb;
      border: 1px solid #d6e2f4;
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--bar), var(--bar2));
      border-radius: 999px;
      transition: width 120ms linear;
    }

    .warn{
      display:none;
      margin: 12px var(--pad) 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff7ed;
      border: 1px dashed #fdba74;
      color: #7c2d12;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
    }

    /* Conte√∫do */
    .stage{
      position:relative;
      flex: 1;
      min-height:0;
      padding: var(--pad);
      overflow:hidden;
      background: var(--panel);
    }

    .page{
      position:absolute;
      inset: var(--pad);
      display:grid;
      gap: 12px;
      align-content:start;
      opacity:0;
      transform: translateX(18px);
      pointer-events:none;
    }
    .page.active{
      opacity:1;
      transform: translateX(0);
      pointer-events:auto;
      transition: opacity 520ms ease, transform 520ms ease;
    }
    .page.exit{
      opacity:0;
      transform: translateX(-18px);
      transition: opacity 520ms ease, transform 520ms ease;
    }

    .card{
      position:relative;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 26px rgba(2,10,23,.08);
      overflow:hidden;
      min-height: 92px;

      display:grid;
      grid-template-columns: 120px 1fr 260px;
      gap: 14px;
      align-items:center;
      padding: 14px 16px;
    }

    .stripe{
      position:absolute;
      inset:0 auto 0 0;
      width: 8px;
      background: #0f3f82;
    }

    .lineCol{
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:flex-start;
      padding-left: 10px;
    }
    .lineNum{
      font-size: 38px;
      font-weight: 900;
      letter-spacing: .02em;
      line-height: 1;
      color: #0b1220;
    }
    .company{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #0b1220;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: #f7faff;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: #0f3f82;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
      flex: 0 0 auto;
    }

    .destCol{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .destName{
      font-size: clamp(24px, 2.4vw, 32px);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: #0b1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .timesCol{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 10px;
    }

    .next{
      width: 100%;
      max-width: 240px;
      text-align:center;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--okSoft);
      border: 2px solid rgba(31, 167, 101, .25);
    }
    .next .when{
      font-size: 36px;
      font-weight: 900;
      letter-spacing: .06em;
      color: var(--ok);
      line-height: 1.05;
    }
    .next .label{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(31, 167, 101, .88);
    }

    .miniLabel{
      width:100%;
      max-width:240px;
      text-align:right;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #334155;
      opacity: .78;
      margin-top: -2px;
    }

    .pills{
      width: 100%;
      max-width: 240px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      flex-wrap: nowrap;
      overflow: hidden;
      gap: 8px;
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: #f1f5f9;
      min-width: 86px;
      text-align:center;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .10em;
      color: #0b1220;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .empty{
      padding: 22px 18px;
      border-radius: 14px;
      background: #f8fafc;
      border: 1px solid var(--stroke2);
      color: var(--dim);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      text-align:center;
    }

    /* Logo discreta no canto da TELA */
    .brand{
      position: fixed;
      bottom: 14px;
      right: 16px;
      opacity: .22;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.14));
      z-index: 999;
    }
    .brand img{ height: 22px; width:auto; display:block; }

    /* Responsivo mantendo o mesmo layout (3 colunas) */
    @media (max-width: 980px){
      body{ padding: 10px; }
      .panel{ width: 98vw; height: calc(100vh - 20px); }

      .header{ padding: 14px var(--pad); gap: 12px; }
      .busIcon{ width: 40px; height: 40px; border-radius: 12px; }
      .busIcon .material-icons-outlined{ font-size: 22px; }

      .title{ font-size: 22px; }
      .sub{ font-size: 11px; max-width: 58vw; }

      .clock{ font-size: 42px; }
      .lastUpdate{ font-size: 11px; }

      .panelTop{ padding: 10px var(--pad); }
      .panelInfo{ font-size: 11px; }
      .pager{ font-size: 11px; gap: 10px; }
      .bar{ width: 170px; height: 9px; }

      .stage{ padding: 12px; }
      .page{ inset: 12px; gap: 10px; }

      .card{
        min-height: 76px;
        padding: 12px 14px;
        gap: 12px;
        grid-template-columns: 96px 1fr 210px;
        border-radius: 14px;
      }
      .stripe{ width: 7px; }
      .lineCol{ gap: 8px; padding-left: 8px; }
      .lineNum{ font-size: 30px; }
      .company{ font-size: 11px; padding: 5px 9px; max-width: 150px; }
      .dot{ width: 9px; height: 9px; }
      .destName{ font-size: 22px; }

      .next{ max-width: 200px; padding: 9px 10px; border-radius: 12px; }
      .next .when{ font-size: 28px; }
      .next .label{ font-size: 10px; margin-top: 5px; }
      .miniLabel{ max-width: 200px; font-size: 10px; }

      .pills{ max-width: 200px; gap: 7px; }
      .pill{ padding: 7px 9px; min-width: 78px; font-size: 11px; }

      .brand{ bottom: 10px; right: 12px; opacity: .18; }
      .brand img{ height: 18px; }
    }

    @media (max-width: 640px){
      .title{ font-size: 18px; }
      .sub{ font-size: 10px; max-width: 54vw; }
      .clock{ font-size: 34px; }

      .bar{ width: 130px; height: 8px; }

      .card{
        grid-template-columns: 86px 1fr 180px;
        padding: 11px 12px;
        min-height: 70px;
      }
      .lineNum{ font-size: 26px; }
      .company{ font-size: 10px; max-width: 130px; }
      .destName{ font-size: 18px; }

      .next{ max-width: 170px; }
      .next .when{ font-size: 24px; }
      .miniLabel{ max-width: 170px; }

      .pills{ max-width: 170px; }
      .pill{ min-width: 70px; font-size: 10px; }
    }
  </style>
</head>

<body>
  <section class="panel" aria-label="Painel de hor√°rios">
    <div class="header">
      <div class="h-left">
        <div class="busIcon" aria-hidden="true">
          <span class="material-icons-outlined">directions_bus</span>
        </div>
        <div class="titleBlock">
          <div class="title" id="stationTitle">Esta√ß√£o Central</div>
          <div class="sub" id="subStatus">Carregando‚Ä¶</div>
        </div>
      </div>

      <div class="h-right">
        <div class="clock" id="clock">--:--</div>
        <div class="lastUpdate" id="lastUpdate">√öltima atualiza√ß√£o ‚Ä¢ ‚Äî</div>
      </div>
    </div>

    <div class="panelTop">
      <div class="panelInfo" id="panelInfo">Pr√≥ximas sa√≠das (2h) ‚Ä¢ Next Bus</div>
      <div class="pager">
        <span id="pageLabel">P√ÅGINA 1/1</span>
        <div class="bar" aria-hidden="true"><div id="barFill"></div></div>
      </div>
    </div>

    <div class="warn" id="warn"></div>
    <div class="stage" id="stage"></div>
  </section>

  <div class="brand" aria-hidden="true">
    <img src="assets/logo.png" alt="">
  </div>

  <!-- ‚úÖ Footer padr√£o PontoView (como voc√™ pediu) -->
  <div class="pvFooter"></div>
  <script src="../pv-footer.js"></script>

  <!-- opcional: config.js  (window.PONTOVIEW_GMAPS_KEY = "SUA_CHAVE"; ) -->
  <script src="config.js"></script>

  <script>
    /*******************************************************************
     * ‚úÖ CONFIG DO CLIENTE (mude s√≥ aqui)
     *
     * Para trocar de cidade/ponto:
     * - Edite STATION_QUERY (nome do terminal/ponto/endere√ßo)
     * - Opcional: STATION_TITLE (nome curto no cabe√ßalho; se vazio, usa o que o Google retornar)
     *
     * Dica: use algo bem espec√≠fico:
     *  "Terminal Rodovi√°rio de Colatina, ES"
     *  "Rodovi√°ria de Vit√≥ria, ES"
     *  "Terminal Itacib√°, Cariacica - ES"
     *******************************************************************/
    const PV_CONFIG = {
      STATION_QUERY: "Terminal Rodovi√°rio de Colatina, ES",
      STATION_TITLE: "Esta√ß√£o Central", // deixe "" para usar o nome retornado pelo Google
      CITY_LABEL: "COLATINA - ES",      // opcional (apenas visual)
      TIME_WINDOW_HOURS: 2,
      REFRESH_EVERY_MIN: 10,
      SWEEP_POINTS: 12,
      SWEEP_RADIUS_M: 1200,
      // ‚úÖ filtro de ‚Äúsa√≠das realmente do ponto‚Äù: aceita somente se a parada de embarque estiver perto do ponto
      STOP_MATCH_RADIUS_M: 250,
      // ‚úÖ agrupar hor√°rios muito pr√≥ximos em range (minutos)
      CLUSTER_GAP_MIN: 2,
      // ‚úÖ remover sa√≠das que j√° passaram (margem)
      PAST_TOLERANCE_MS: 20000
    };

    /*******************************************************************
     * üîë CHAVE GOOGLE MAPS
     *******************************************************************/
    const GOOGLE_MAPS_API_KEY = (window.PONTOVIEW_GMAPS_KEY || "").trim() || "COLE_SUA_API_KEY_AQUI";

    /*******************************************************************
     * UI refs
     *******************************************************************/
    const clockEl = document.getElementById("clock");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const subStatusEl = document.getElementById("subStatus");
    const warnEl = document.getElementById("warn");
    const stageEl = document.getElementById("stage");
    const pageLabelEl = document.getElementById("pageLabel");
    const barFillEl = document.getElementById("barFill");
    const stationTitleEl = document.getElementById("stationTitle");
    const panelInfoEl = document.getElementById("panelInfo");

    function pad2(n){ return String(n).padStart(2,"0"); }

    /*******************************************************************
     * Clock (sem segundos)
     *******************************************************************/
    function tickClock(){
      const d = new Date();
      clockEl.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function startClock(){
      tickClock();
      const ms = 1000 - new Date().getMilliseconds();
      setTimeout(() => { tickClock(); setInterval(tickClock, 1000); }, ms);
    }

    /*******************************************************************
     * Loader Google Maps
     *******************************************************************/
    function loadGoogleMaps(){
      return new Promise((resolve, reject) => {
        if (window.google?.maps) return resolve();

        const key = (GOOGLE_MAPS_API_KEY || "").trim();
        if (!key || key === "COLE_SUA_API_KEY_AQUI"){
          warnEl.style.display = "block";
          warnEl.textContent = "INSIRA SUA GOOGLE MAPS API KEY (config.js OU CONSTANTE GOOGLE_MAPS_API_KEY).";
          return reject(new Error("Missing API key"));
        }

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}`;
        script.async = true;
        script.defer = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("Falha ao carregar Google Maps JS API"));
        document.head.appendChild(script);
      });
    }

    /*******************************************************************
     * ‚úÖ Geocoding: resolve STATION_QUERY -> lat/lng + nome formatado
     *******************************************************************/
    async function geocodeStation(){
      return new Promise((resolve, reject) => {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: PV_CONFIG.STATION_QUERY }, (results, status) => {
          if (status !== "OK" || !results?.length){
            reject(new Error("Falha no geocoding: " + status));
            return;
          }
          const r = results[0];
          const loc = r.geometry.location;
          resolve({
            lat: loc.lat(),
            lng: loc.lng(),
            formatted_name: r.formatted_address || PV_CONFIG.STATION_QUERY
          });
        });
      });
    }

    /*******************************************************************
     * Geodesia (destinos invis√≠veis)
     *******************************************************************/
    function toRad(deg){ return deg * Math.PI / 180; }
    function toDeg(rad){ return rad * 180 / Math.PI; }

    function destinationPoint(lat, lng, bearingDeg, distanceM){
      const R = 6371000;
      const brng = toRad(bearingDeg);
      const dDivR = distanceM / R;
      const lat1 = toRad(lat);
      const lon1 = toRad(lng);

      const lat2 = Math.asin(
        Math.sin(lat1)*Math.cos(dDivR) +
        Math.cos(lat1)*Math.sin(dDivR)*Math.cos(brng)
      );
      const lon2 = lon1 + Math.atan2(
        Math.sin(brng)*Math.sin(dDivR)*Math.cos(lat1),
        Math.cos(dDivR) - Math.sin(lat1)*Math.sin(lat2)
      );

      return { lat: toDeg(lat2), lng: toDeg(lon2) };
    }

    function buildSweepDestinations(station){
      const points = [];
      for (let i=0;i<PV_CONFIG.SWEEP_POINTS;i++){
        const bearing = i * (360 / PV_CONFIG.SWEEP_POINTS);
        points.push(destinationPoint(station.lat, station.lng, bearing, PV_CONFIG.SWEEP_RADIUS_M));
      }
      return points;
    }

    /*******************************************************************
     * Dist√¢ncia (Haversine) p/ filtrar sa√≠da do ponto
     *******************************************************************/
    function haversineM(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /*******************************************************************
     * Parsing Directions (SA√çDA somente) + Ag√™ncia/Cor quando existir
     *******************************************************************/
    function toMillis(v){
      if (!v) return null;
      if (v instanceof Date) return v.getTime();
      if (typeof v === "number"){
        if (v > 1e12) return v;       // ms
        if (v > 1e9)  return v*1000;  // s
      }
      if (typeof v === "object" && v.value) return toMillis(v.value);
      return null;
    }

    function normalizeHexColor(c){
      if (!c) return null;
      let s = String(c).trim();
      if (!s) return null;
      if (!s.startsWith("#")) s = "#" + s;
      if (!/^#[0-9A-Fa-f]{6}$/.test(s)) return null;
      return s;
    }

    function extractTripsFromDirectionsResult(result, station){
      const trips = [];
      if (!result?.routes?.length) return trips;

      for (const route of result.routes){
        const leg = route.legs?.[0];
        if (!leg?.steps?.length) continue;

        for (const step of leg.steps){
          if (step.travel_mode !== "TRANSIT" || !step.transit) continue;

          const td = step.transit;

          // ‚úÖ apenas SA√çDA
          const depMs = toMillis(td.departure_time) || toMillis(td.departure_time?.value);
          if (!depMs || !Number.isFinite(depMs)) continue;

          // ‚úÖ filtro por proximidade do ponto (evita ‚Äúsa√≠das‚Äù de paradas distantes)
          const stopLoc = td.departure_stop?.location;
          if (stopLoc && typeof stopLoc.lat === "function" && typeof stopLoc.lng === "function"){
            const d = haversineM(station.lat, station.lng, stopLoc.lat(), stopLoc.lng());
            if (d > PV_CONFIG.STOP_MATCH_RADIUS_M) continue;
          }

          const lineShort = td.line?.short_name || td.line?.name || "‚Äî";
          const headsign = td.headsign || td.line?.name || td.arrival_stop?.name || "Destino";

          // ‚úÖ ag√™ncia / cor (quando existir no GTFS)
          const agencyName = td.line?.agencies?.[0]?.name || "";
          const lineColor = normalizeHexColor(td.line?.color) || null;
          const textColor = normalizeHexColor(td.line?.text_color) || null;

          trips.push({
            line: String(lineShort),
            destination: String(headsign),
            timeMs: depMs,
            agency: agencyName,
            lineColor,
            textColor,
            key: `${String(lineShort)}|${String(headsign)}|${depMs}|${agencyName}|${lineColor||""}`
          });
        }
      }
      return trips;
    }

    /*******************************************************************
     * Dedup + agrupa + janela
     *******************************************************************/
    function aggregateTrips(allTrips){
      const uniqMap = new Map();
      for (const t of allTrips) uniqMap.set(t.key, t);
      const uniq = Array.from(uniqMap.values());

      const now = Date.now();
      const end = now + (PV_CONFIG.TIME_WINDOW_HOURS * 60 * 60 * 1000);

      const groups = new Map();
      for (const t of uniq){
        if (t.timeMs < now - PV_CONFIG.PAST_TOLERANCE_MS) continue;
        if (t.timeMs > end) continue;

        // agrupa por linha + destino + ag√™ncia (mant√©m cores consistentes)
        const gKey = `${t.line}||${t.destination}||${t.agency || ""}||${t.lineColor || ""}`;
        if (!groups.has(gKey)){
          groups.set(gKey, {
            line: t.line,
            destination: t.destination,
            times: [],
            agency: t.agency,
            lineColor: t.lineColor,
            textColor: t.textColor
          });
        }
        groups.get(gKey).times.push(t.timeMs);
      }

      const cards = [];
      for (const g of groups.values()){
        g.times.sort((a,b) => a-b);
        if (!g.times.length) continue;

        cards.push({
          line: g.line,
          destination: g.destination,
          times: g.times,
          nextTime: g.times[0],
          agency: g.agency,
          lineColor: g.lineColor,
          textColor: g.textColor
        });
      }

      cards.sort((a,b) => a.nextTime - b.nextTime);
      return cards;
    }

    function fmtHHMM(ms){
      if (!Number.isFinite(ms)) return "--:--";
      const d = new Date(ms);
      const hh = d.getHours(), mm = d.getMinutes();
      if (!Number.isFinite(hh) || !Number.isFinite(mm)) return "--:--";
      return `${pad2(hh)}:${pad2(mm)}`;
    }

    function diffMin(aMs, bMs){
      return Math.round(Math.abs(aMs - bMs) / 60000);
    }

    // ‚úÖ clusters (ranges) e BLINDADO para vazio
    function clusterTimes(timesMs){
      const t = (timesMs || []).slice().sort((a,b)=>a-b);
      if (!t.length) return [];

      const clusters = [];
      let current = [t[0]];

      for (let i=1;i<t.length;i++){
        if (diffMin(t[i], t[i-1]) <= PV_CONFIG.CLUSTER_GAP_MIN){
          current.push(t[i]);
        } else {
          clusters.push(current);
          current = [t[i]];
        }
      }
      clusters.push(current);

      return clusters.map(c => {
        if (c.length === 1) return fmtHHMM(c[0]);
        return `${fmtHHMM(c[0])}‚Äì${fmtHHMM(c[c.length-1])}`;
      });
    }

    /*******************************************************************
     * Directions: varredura
     *******************************************************************/
    let directionsService = null;
    let refreshTimer = null;
    let STATION = null;

    function setStatus(text){ subStatusEl.textContent = text; }

    function requestDirectionsTo(dest){
      return new Promise((resolve) => {
        const req = {
          origin: STATION,
          destination: dest,
          travelMode: google.maps.TravelMode.TRANSIT,
          provideRouteAlternatives: true,
          transitOptions: { departureTime: new Date() }
        };

        directionsService.route(req, (result, status) => {
          if (status === "OK" && result) resolve({ ok:true, result });
          else resolve({ ok:false, status });
        });
      });
    }

    /*******************************************************************
     * Pagina√ß√£o + UI
     *******************************************************************/
    let currentCards = [];
    let pages = [];
    let pageIndex = 0;

    let pageTimer = null;
    let progressTimer = null;
    let pageStart = 0;

    const PAGE_DURATION_MS = 12000;
    const PAGE_PROGRESS_TICK_MS = 120;
    const MIN_ITEMS_PER_PAGE = 4;

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function buildCardEl(card){
      const el = document.createElement("div");
      el.className = "card";

      // ‚úÖ cor vinda do GTFS (linha) quando existir
      const stripeColor = card.lineColor || "#0f3f82";
      const dotColor = stripeColor;

      const stripe = document.createElement("div");
      stripe.className = "stripe";
      stripe.style.background = stripeColor;

      const next = fmtHHMM(card.times[0]);

      // ‚úÖ p√≠lulas (sem duplicar o destaque)
      const rest = card.times.slice(1);
      const pillTexts = clusterTimes(rest);
      const hasNext = pillTexts.length > 0;

      const pillsHtml = pillTexts.map(txt => `<div class="pill">${escapeHtml(txt)}</div>`).join("");

      // ‚úÖ ‚Äúempresa‚Äù: usa nome da ag√™ncia; fallback para VJD/VSR se vier vazio
      const agencyLabel = (card.agency || "").trim() || "√îNIBUS";

      el.innerHTML = `
        <div class="lineCol">
          <div class="lineNum">${escapeHtml(card.line)}</div>
          <div class="company" title="${escapeHtml(agencyLabel)}">
            <span class="dot" style="background:${escapeHtml(dotColor)}"></span>
            <span>${escapeHtml(agencyLabel)}</span>
          </div>
        </div>

        <div class="destCol">
          <div class="destName">${escapeHtml(card.destination)}</div>
        </div>

        <div class="timesCol">
          <div class="next">
            <div class="when">${next}</div>
            <div class="label">SA√çDA</div>
          </div>

          <div class="miniLabel" style="${hasNext ? "" : "display:none"}">Pr√≥ximos hor√°rios</div>
          <div class="pills" style="${hasNext ? "" : "display:none"}">${pillsHtml}</div>
        </div>
      `;
      el.prepend(stripe);
      return el;
    }

    function clearTimers(){
      if (pageTimer) clearTimeout(pageTimer);
      if (progressTimer) clearInterval(progressTimer);
      pageTimer = null;
      progressTimer = null;
    }

    function setPagerLabel(){
      const total = Math.max(1, pages.length);
      pageLabelEl.textContent = `P√ÅGINA ${Math.min(pageIndex+1, total)}/${total}`;
    }

    function setProgress(p){
      const pct = Math.max(0, Math.min(100, p));
      barFillEl.style.width = pct + "%";
    }

    function measureItemsPerPage(sampleCardEl){
      const stageRect = stageEl.getBoundingClientRect();
      const available = stageRect.height;

      const cardRect = sampleCardEl.getBoundingClientRect();
      const cardH = cardRect.height;

      const gap = 12;
      let n = Math.floor((available + gap) / (cardH + gap));
      n = Math.max(MIN_ITEMS_PER_PAGE, n);
      return n;
    }

    // ‚úÖ compacta texto para caber dentro de uma pill (com retic√™ncias)
    const __measureCanvas = document.createElement("canvas");
    const __measureCtx = __measureCanvas.getContext("2d");

    function compactTextToWidth(el, text){
      const cs = getComputedStyle(el);
      const font = `${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
      __measureCtx.font = font;

      const maxW = Math.max(0, el.clientWidth - 18);
      if (maxW <= 0) return "‚Ä¶";

      if (__measureCtx.measureText(text).width <= maxW) return text;

      let s = text;
      while (s.length > 1 && __measureCtx.measureText(s + "‚Ä¶").width > maxW){
        s = s.slice(0, -1);
      }
      return s + "‚Ä¶";
    }

    // ‚úÖ ajusta automaticamente quantas p√≠lulas cabem (BLINDADO p/ oculto/vazio)
    function fitPillsToWidth(cardEl){
      const pillsEl = cardEl.querySelector(".pills");
      if (!pillsEl) return;

      // oculto? n√£o mede
      if (getComputedStyle(pillsEl).display === "none") return;

      let pills = Array.from(pillsEl.children);
      if (!pills.length) return;

      const maxW = pillsEl.clientWidth;
      const gap = parseFloat(getComputedStyle(pillsEl).gap || "0") || 0;

      pills.forEach(p => p.style.display = "");

      let used = 0;
      let count = 0;

      for (let i = 0; i < pills.length; i++){
        const w = pills[i].getBoundingClientRect().width;
        const nextUsed = used + (count > 0 ? gap : 0) + w;

        if (nextUsed <= maxW){
          used = nextUsed;
          count++;
          continue;
        }
        break;
      }

      // Se n√£o coube nenhuma (tela muito estreita), mostra s√≥ uma p√≠lula compactada
      if (count === 0){
        const all = pills.map(p => p.textContent.trim()).filter(Boolean);
        pillsEl.innerHTML = `<div class="pill"></div>`;
        const one = pillsEl.querySelector(".pill");
        one.textContent = compactTextToWidth(one, all.join(" ‚Ä¢ "));
        return;
      }

      // Esconde as que n√£o couberam
      for (let i = count; i < pills.length; i++){
        pills[i].style.display = "none";
      }

      // Se escondeu alguma, transforma a √∫ltima vis√≠vel em "‚Ä¶"
      const hidden = pills.length - count;
      if (hidden > 0 && count >= 1){
        const last = pills[count - 1];
        const base = last.textContent.trim();
        last.textContent = compactTextToWidth(last, base + " ‚Ä¢ ‚Ä¶");
      }
    }

    function paginateCards(cards){
      stageEl.innerHTML = "";
      pages = [];
      pageIndex = 0;

      if (!cards.length){
        const p = document.createElement("div");
        p.className = "page active";
        p.innerHTML = `<div class="empty">Nenhuma sa√≠da encontrada nas pr√≥ximas ${PV_CONFIG.TIME_WINDOW_HOURS} horas.</div>`;
        stageEl.appendChild(p);
        pages = [p];
        setPagerLabel();
        setProgress(100);
        return;
      }

      const sample = buildCardEl(cards[0]);
      const tmp = document.createElement("div");
      tmp.style.position = "absolute";
      tmp.style.inset = "var(--pad)";
      tmp.style.visibility = "hidden";
      tmp.style.pointerEvents = "none";
      tmp.style.display = "grid";
      tmp.style.gap = "12px";
      tmp.appendChild(sample);
      stageEl.appendChild(tmp);

      const perPage = measureItemsPerPage(sample);
      stageEl.removeChild(tmp);

      for (let i=0; i<cards.length; i += perPage){
        const chunk = cards.slice(i, i+perPage);

        const page = document.createElement("div");
        page.className = "page";
        for (const c of chunk){
          const cardEl = buildCardEl(c);
          page.appendChild(cardEl);
          requestAnimationFrame(() => fitPillsToWidth(cardEl));
        }
        stageEl.appendChild(page);
        pages.push(page);
      }

      pages[0].classList.add("active");
      setPagerLabel();
      startPaging();
    }

    function showPage(nextIndex){
      if (!pages.length) return;

      const from = pages[pageIndex];
      const to = pages[nextIndex];
      if (from === to) return;

      from.classList.remove("active");
      from.classList.add("exit");

      to.classList.remove("exit");
      void to.offsetWidth;
      to.classList.add("active");

      setTimeout(() => from.classList.remove("exit"), 560);

      pageIndex = nextIndex;
      setPagerLabel();
      setProgress(0);

      requestAnimationFrame(() => {
        const active = pages[pageIndex];
        if (!active) return;
        active.querySelectorAll(".card").forEach(el => fitPillsToWidth(el));
      });
    }

    function startPaging(){
      clearTimers();
      if (pages.length <= 1){
        setProgress(100);
        return;
      }

      pageStart = Date.now();
      setProgress(0);

      progressTimer = setInterval(() => {
        const elapsed = Date.now() - pageStart;
        setProgress((elapsed / PAGE_DURATION_MS) * 100);
      }, PAGE_PROGRESS_TICK_MS);

      pageTimer = setTimeout(() => {
        const next = (pageIndex + 1) % pages.length;
        showPage(next);
        startPaging();
      }, PAGE_DURATION_MS);
    }

    /*******************************************************************
     * Refresh
     *******************************************************************/
    async function refreshData(){
      setStatus("Atualizando sa√≠das‚Ä¶");
      const t0 = performance.now();

      if (!directionsService) directionsService = new google.maps.DirectionsService();

      const destinations = buildSweepDestinations(STATION);
      const responses = await Promise.all(destinations.map(d => requestDirectionsTo(d)));

      const allTrips = [];
      let okCount = 0;

      for (const r of responses){
        if (r.ok){
          okCount++;
          allTrips.push(...extractTripsFromDirectionsResult(r.result, STATION));
        }
      }

      const cards = aggregateTrips(allTrips);
      currentCards = cards;

      paginateCards(cards);

      const dt = Math.round(performance.now() - t0);
      const now = new Date();
      const hhmm = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

      lastUpdateEl.textContent = `√öltima atualiza√ß√£o ‚Ä¢ ${hhmm}`;

      if (!okCount){
        setStatus("Sem resposta da API (verifique a KEY e restri√ß√µes).");
      } else {
        setStatus(`Pr√≥ximas sa√≠das ‚Ä¢ ${cards.length} linhas`);
      }

      // info da faixa superior
      panelInfoEl.textContent = `Pr√≥ximas sa√≠das (${PV_CONFIG.TIME_WINDOW_HOURS}h) ‚Ä¢ Next Bus`;
    }

    function scheduleRefresh(){
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(refreshData, PV_CONFIG.REFRESH_EVERY_MIN * 60 * 1000);
    }

    /*******************************************************************
     * BOOT
     *******************************************************************/
    startClock();

    (async function boot(){
      try{
        setStatus("Carregando Google Maps‚Ä¶");
        await loadGoogleMaps();
        warnEl.style.display = "none";

        setStatus("Definindo ponto‚Ä¶");
        const geo = await geocodeStation();
        STATION = { lat: geo.lat, lng: geo.lng };

        // t√≠tulo no cabe√ßalho (padr√£o: PV_CONFIG.STATION_TITLE; sen√£o usa o nome do Google)
        const title = (PV_CONFIG.STATION_TITLE || "").trim() || geo.formatted_name;
        stationTitleEl.textContent = title;

        // sub-status ‚Äúcidade‚Äù
        const city = (PV_CONFIG.CITY_LABEL || "").trim();
        if (city) {
          // deixa o subStatus livre para estado, mas j√° ‚Äúmarca‚Äù o contexto
          // o setStatus vai sobrescrever depois com "Pr√≥ximas sa√≠das..."
        }

        await refreshData();
        scheduleRefresh();

        window.addEventListener("resize", () => paginateCards(currentCards || []));
      }catch(err){
        console.warn(err);
        setStatus("Aguardando configura√ß√£o‚Ä¶");

        warnEl.style.display = "block";
        warnEl.textContent =
          "N√ÉO FOI POSS√çVEL INICIAR. VERIFIQUE: API KEY / GEOCODING ATIVADO / STATION_QUERY V√ÅLIDO.";
      }
    })();
  </script>
</body>
</html>
